{% extends 'base.html' %}
{% load static %}

{% block title %}Memory Match Game - DailySoul{% endblock %}

{% block content %}
<div class="container">
    <h1>Memory Match Game</h1>

    <div class="game-info">
        <div class="info-item">
            <div class="info-label">Moves</div>
            <div class="info-value" id="moves">0</div>
        </div>
        <div class="info-item">
            <div class="info-label">Matches</div>
            <div class="info-value" id="matches">0/8</div>
        </div>
        <div class="info-item">
            <div class="info-label">Time</div>
            <div class="info-value" id="timer">0s</div>
        </div>
    </div>

    <div class="game-board" id="game-board">
        <!-- Cards will be generated by JavaScript -->
    </div>

    <div class="controls">
        <button id="reset-btn">New Game</button>
        <button id="hint-btn">Hint</button>
        <button id="leave-btn">Leave Game</button>
    </div>

    <div class="win-message" id="win-message">
        <div class="win-content">
            <div class="close-btn" id="close-win-message">Ã—</div>
            <h2>Congratulations!</h2>
            <p>You've matched all the pairs!</p>
            <p id="final-stats">Moves: 0 | Time: 0s</p>
            <button id="play-again-btn">Play Again</button>
        </div>
    </div>
</div>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .container {
        max-width: 800px;
        width: 100%;
        text-align: center;
        margin: 0 auto;
        padding: 20px;
    }

    h1 {
        color: white;
        margin: 20px 0;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        font-size: 2.5rem;
    }

    .game-info {
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-around;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .info-item {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .info-label {
        font-size: 0.9rem;
        color: #555;
        margin-bottom: 5px;
    }

    .info-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #6e8efb;
    }

    .game-board {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin: 0 auto;
        max-width: 600px;
        perspective: 1000px;
    }

    .card {
        height: 120px;
        position: relative;
        transform-style: preserve-3d;
        transition: transform 0.5s;
        cursor: pointer;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .card.flipped {
        transform: rotateY(180deg);
    }

    .card.matched {
        cursor: default;
        transform: rotateY(180deg);
    }

    .card-front, .card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
    }

    .card-front {
        background-color: #6e8efb;
        color: white;
        transform: rotateY(180deg);
    }

    .card-back {
        background: linear-gradient(45deg, #ff9a9e, #fad0c4);
        color: rgba(255, 255, 255, 0.8);
    }

    .controls {
        margin-top: 30px;
        display: flex;
        justify-content: center;
        gap: 15px;
    }

    button {
        background-color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 50px;
        font-size: 1rem;
        font-weight: bold;
        color: #6e8efb;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    button:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }

    button:active {
        transform: translateY(1px);
    }

    #leave-btn {
        background-color: #ff6b6b;
        color: white;
    }

    .win-message {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 100;
        color: white;
        text-align: center;
        display: none;
    }

    .win-content {
        background: linear-gradient(135deg, #6e8efb, #a777e3);
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        max-width: 500px;
        width: 90%;
        position: relative;
    }

    .close-btn {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 2rem;
        cursor: pointer;
        color: white;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .close-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
    }

    .win-content h2 {
        font-size: 2.5rem;
        margin-bottom: 20px;
    }

    .win-content p {
        font-size: 1.2rem;
        margin-bottom: 30px;
    }

    @media (max-width: 600px) {
        .game-board {
            grid-template-columns: repeat(3, 1fr);
        }

        .card {
            height: 100px;
        }

        h1 {
            font-size: 2rem;
        }

        .controls {
            flex-wrap: wrap;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Game elements
        const gameBoard = document.getElementById('game-board');
        const movesDisplay = document.getElementById('moves');
        const matchesDisplay = document.getElementById('matches');
        const timerDisplay = document.getElementById('timer');
        const resetBtn = document.getElementById('reset-btn');
        const hintBtn = document.getElementById('hint-btn');
        const leaveBtn = document.getElementById('leave-btn');
        const winMessage = document.getElementById('win-message');
        const finalStats = document.getElementById('final-stats');
        const playAgainBtn = document.getElementById('play-again-btn');
        const closeWinMessage = document.getElementById('close-win-message');

        // Game state
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let moves = 0;
        let timer = 0;
        let timerInterval;
        let gameStarted = false;
        let canFlip = true;

        // Card symbols (8 pairs)
        const cardSymbols = ['ðŸŽ', 'ðŸŒ', 'ðŸ’', 'ðŸ‡', 'ðŸŠ', 'ðŸ“', 'ðŸ‘', 'ðŸ¥'];

        // Initialize the game
        function initGame() {
            // Clear the game board
            gameBoard.innerHTML = '';

            // Reset game state
            cards = [];
            flippedCards = [];
            matchedPairs = 0;
            moves = 0;
            timer = 0;
            gameStarted = false;
            canFlip = true;

            // Update displays
            movesDisplay.textContent = moves;
            matchesDisplay.textContent = `${matchedPairs}/8`;
            timerDisplay.textContent = '0s';

            // Clear timer if running
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            // Create card pairs
            const gameCards = [...cardSymbols, ...cardSymbols];

            // Shuffle the cards
            shuffleArray(gameCards);

            // Create card elements
            gameCards.forEach((symbol, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.index = index;
                card.dataset.symbol = symbol;

                const cardFront = document.createElement('div');
                cardFront.className = 'card-front';
                cardFront.textContent = symbol;

                const cardBack = document.createElement('div');
                cardBack.className = 'card-back';
                cardBack.textContent = '?';

                card.appendChild(cardFront);
                card.appendChild(cardBack);

                card.addEventListener('click', () => flipCard(card));

                gameBoard.appendChild(card);
                cards.push(card);
            });
        }

        // Flip a card
        function flipCard(card) {
            // Check if we can flip the card
            if (!canFlip || card.classList.contains('flipped') || card.classList.contains('matched')) {
                return;
            }

            // Start the timer on first flip
            if (!gameStarted) {
                startTimer();
                gameStarted = true;
            }

            // Flip the card
            card.classList.add('flipped');
            flippedCards.push(card);

            // Check for a match if two cards are flipped
            if (flippedCards.length === 2) {
                canFlip = false;
                moves++;
                movesDisplay.textContent = moves;

                checkForMatch();
            }
        }

        // Check if the two flipped cards match
        function checkForMatch() {
            const [card1, card2] = flippedCards;
            const isMatch = card1.dataset.symbol === card2.dataset.symbol;

            if (isMatch) {
                // Cards match
                card1.classList.add('matched');
                card2.classList.add('matched');
                matchedPairs++;
                matchesDisplay.textContent = `${matchedPairs}/8`;

                flippedCards = [];
                canFlip = true;

                // Check for win
                if (matchedPairs === 8) {
                    endGame();
                }
            } else {
                // Cards don't match - flip them back after a delay
                setTimeout(() => {
                    card1.classList.remove('flipped');
                    card2.classList.remove('flipped');
                    flippedCards = [];
                    canFlip = true;
                }, 1000);
            }
        }

        // Start the game timer
        function startTimer() {
            timerInterval = setInterval(() => {
                timer++;
                timerDisplay.textContent = `${timer}s`;
            }, 1000);
        }

        // End the game
        function endGame() {
            clearInterval(timerInterval);
            finalStats.textContent = `Moves: ${moves} | Time: ${timer}s`;
            winMessage.style.display = 'flex';
        }

        // Leave the game
        function leaveGame() {
            // Stop the timer
            clearInterval(timerInterval);

            // Hide win message if visible
            winMessage.style.display = 'none';

            // Reset the game
            initGame();

            // Show confirmation (you can customize this)
            alert("You've left the game. Start a new game whenever you're ready!");
        }

        // Shuffle array using Fisher-Yates algorithm
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Show a hint by briefly showing all cards
        function showHint() {
            if (!gameStarted || !canFlip) return;

            canFlip = false;

            // Flip all cards
            cards.forEach(card => {
                if (!card.classList.contains('matched')) {
                    card.classList.add('flipped');
                }
            });

            // Flip them back after a delay
            setTimeout(() => {
                cards.forEach(card => {
                    if (!card.classList.contains('matched')) {
                        card.classList.remove('flipped');
                    }
                });
                canFlip = true;
            }, 1000);
        }

        // Event listeners
        resetBtn.addEventListener('click', initGame);
        hintBtn.addEventListener('click', showHint);
        leaveBtn.addEventListener('click', leaveGame);
        playAgainBtn.addEventListener('click', () => {
            winMessage.style.display = 'none';
            initGame();
        });
        closeWinMessage.addEventListener('click', () => {
            winMessage.style.display = 'none';
            initGame();
        });

        // Initialize the game on page load
        initGame();
    });
</script>
{% endblock %}